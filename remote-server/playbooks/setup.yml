---
# Complete Server Setup Playbook
# Runs system preparation, reboots, then Docker setup, then Traefik

- name: Complete Server Setup
  hosts: docker_servers
  become: true
  gather_facts: false  # We'll gather facts after connection is established
  
  vars_files:
    - ../group_vars/vault.yml
    - ../group_vars/all.yml
    - ../group_vars/docker.yml
    - ../group_vars/traefik.yml
    - ../group_vars/netdata.yml
    - ../group_vars/crowdsec.yml
    
  pre_tasks:
    # Dynamic Connection Detection and Setup
    - name: Detect optimal connection method
      block:
        - name: Try connecting with current inventory settings first
          ansible.builtin.setup:
          register: connection_test
          ignore_errors: true
          
        - name: Connection successful with current settings
          ansible.builtin.debug:
            msg: "‚úÖ Connected successfully with {{ ansible_user }}@{{ ansible_host }}"
          when: connection_test is not failed
          
        - name: Try alternative connection methods if current failed
          block:
            # Try admin user with Tailscale hostname
            - name: Test admin user with Tailscale connection
              ansible.builtin.setup:
              vars:
                ansible_user: admin
                ansible_host: "{{ inventory_hostname }}.{{ tailscale_magic_dns_suffix | default('tail6d423d.ts.net') }}"
              register: admin_tailscale_test
              ignore_errors: true
              
            - name: Switch to admin user with Tailscale if successful
              ansible.builtin.set_fact:
                ansible_user: admin
                ansible_host: "{{ inventory_hostname }}.{{ tailscale_magic_dns_suffix | default('tail6d423d.ts.net') }}"
                connection_method: "admin_tailscale"
              when: admin_tailscale_test is not failed
              
            # Try ubuntu user with public IP if admin+Tailscale failed
            - name: Test ubuntu user with public IP connection
              ansible.builtin.setup:
              vars:
                ansible_user: ubuntu
                ansible_host: "{{ server_public_ip }}"
              register: ubuntu_public_test
              ignore_errors: true
              when: admin_tailscale_test is failed
              
            - name: Switch to ubuntu user with public IP if successful
              ansible.builtin.set_fact:
                ansible_user: ubuntu
                ansible_host: "{{ server_public_ip }}"
                connection_method: "ubuntu_public"
              when: 
                - admin_tailscale_test is failed
                - ubuntu_public_test is not failed
                
            # Final fallback: admin user with public IP
            - name: Test admin user with public IP connection
              ansible.builtin.setup:
              vars:
                ansible_user: admin
                ansible_host: "{{ server_public_ip }}"
              register: admin_public_test
              ignore_errors: true
              when: 
                - admin_tailscale_test is failed
                - ubuntu_public_test is failed
                
            - name: Switch to admin user with public IP if successful
              ansible.builtin.set_fact:
                ansible_user: admin
                ansible_host: "{{ server_public_ip }}"
                connection_method: "admin_public"
              when: 
                - admin_tailscale_test is failed
                - ubuntu_public_test is failed
                - admin_public_test is not failed
                
            - name: All connection methods failed
              ansible.builtin.fail:
                msg: |
                  ‚ùå Cannot establish SSH connection with any method:
                  - admin@{{ inventory_hostname }}.{{ tailscale_magic_dns_suffix | default('tail6d423d.ts.net') }}
                  - ubuntu@{{ server_public_ip }}
                  - admin@{{ server_public_ip }}
                  
                  Please check:
                  1. Server is running and accessible
                  2. SSH keys are correctly configured
                  3. Tailscale is configured if using magic DNS
                  4. Firewall allows SSH access from your IP
              when: 
                - admin_tailscale_test is failed
                - ubuntu_public_test is failed  
                - admin_public_test is failed
                
          when: connection_test is failed
          
        # Set connection facts based on successful method
        - name: Set connection method fact for current settings
          ansible.builtin.set_fact:
            connection_method: "current_inventory"
          when: connection_test is not failed
          
      tags: always
      
    # Now gather facts with established connection
    - name: Gather system facts
      ansible.builtin.setup:
      tags: always

    - name: Display connection status
      ansible.builtin.debug:
        msg:
          - "üîó Connection established:"
          - "   Method: {{ connection_method | default('current_inventory') }}"
          - "   User: {{ ansible_user }}"
          - "   Host: {{ ansible_host }}"
          - "   Target: {{ inventory_hostname }} ({{ ansible_default_ipv4.address }})"
      tags: always

    - name: Display complete setup banner
      ansible.builtin.debug:
        msg:
          - "=================================================="
          - "üöÄ COMPLETE SERVER SETUP"
          - "=================================================="
          - ""
          - "Target: {{ inventory_hostname }} ({{ ansible_default_ipv4.address }})"
          - "This will:"
          - "1. System hardening and preparation"
          - "2. CrowdSec security engine installation"
          - "3. Reboot server"
          - "4. Docker installation and configuration"
          - "5. Traefik reverse proxy setup"
          - "6. Netdata monitoring system"
          - ""
          - "‚ö†Ô∏è  Server will reboot during this process"
          - "üîí SSH access will be restricted to admin user"
          - "üåê Tailscale will be configured for secure access"
          - ""
      tags: always

    - name: Check minimum system requirements
      ansible.builtin.assert:
        that:
          - ansible_distribution == "Ubuntu"
          - ansible_distribution_major_version | int >= 20
          - ansible_memtotal_mb >= 1024
          - ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_available') | first > 5000000000
        fail_msg: "Requirements: Ubuntu 20.04+, 1GB RAM, 5GB disk space"
        success_msg: "System requirements met"
      tags: always

  tasks:
    # Phase 1: System Preparation
    - name: Run system preparation roles
      ansible.builtin.include_role:
        name: "{{ item }}"
      loop:
        - system_update
        - user_management
        - tailscale
        - firewall
        - crowdsec
        - ssh_hardening
        - kernel_hardening
        - logging
        - validation
      tags:
        - system_preparation
        - phase1

    - name: Switch to secure connection method before reboot
      block:
        - name: Get Tailscale IP and Magic DNS info
          ansible.builtin.set_fact:
            tailscale_magic_dns: "{{ inventory_hostname }}.{{ tailscale_magic_dns_suffix | default('tail6d423d.ts.net') }}"
          when: tailscale_ip is defined
          
        - name: Update connection to use admin user and Tailscale after hardening
          ansible.builtin.set_fact:
            ansible_user: admin
            ansible_host: "{{ tailscale_magic_dns }}"
            connection_method: "secure_tailscale"
          when: 
            - tailscale_ip is defined
            - connection_method in ['ubuntu_public', 'admin_public']
            
        - name: Display connection switch notice
          ansible.builtin.debug:
            msg:
              - "üîÑ Switching to secure connection method:"
              - "   From: {{ ansible_user }}@{{ ansible_host }}"
              - "   To: admin@{{ tailscale_magic_dns }}"
              - "   Reason: SSH hardening applied, using Tailscale for security"
          when: 
            - tailscale_ip is defined
            - connection_method in ['ubuntu_public', 'admin_public']
            
      tags:
        - system_preparation
        - phase1

    - name: Display pre-reboot status
      ansible.builtin.debug:
        msg:
          - "================================================================"
          - "‚úÖ SYSTEM PREPARATION COMPLETED"
          - "================================================================"
          - ""
          - "System hardening complete. Rebooting server to apply changes..."
          - "Server will restart and Docker setup will continue automatically."
          - "Post-reboot connection: admin@{{ tailscale_magic_dns | default(inventory_hostname) }}"
          - ""
      tags:
        - system_preparation
        - phase1

    # Phase 2: Reboot
    - name: Reboot server to apply system changes
      ansible.builtin.reboot:
        reboot_timeout: 600
        connect_timeout: 30
        test_command: uptime
        msg: "Rebooting to apply system preparation changes"
      tags:
        - reboot
        - phase2

    - name: Wait for server to be fully ready
      ansible.builtin.wait_for_connection:
        timeout: 300
        delay: 30
      tags:
        - reboot
        - phase2

    - name: Verify server is back online
      ansible.builtin.setup:
      tags:
        - reboot
        - phase2

    - name: Display post-reboot status
      ansible.builtin.debug:
        msg:
          - "================================================================"
          - "üîÑ SERVER REBOOT COMPLETED"
          - "================================================================"
          - ""
          - "Server is back online. Starting Docker installation..."
          - "Connection: {{ ansible_user }}@{{ ansible_host }}"
          - ""
      tags:
        - reboot
        - phase2

    # Phase 3: Docker Setup
    - name: Run Docker installation roles
      ansible.builtin.include_role:
        name: "{{ item }}"
      loop:
        - docker_installation
        - docker_configuration
        - docker_production
        - docker_validation
      tags:
        - docker_setup
        - phase3

    - name: Display Docker setup completion
      ansible.builtin.debug:
        msg:
          - "================================================================"
          - "üê≥ DOCKER SETUP COMPLETED"
          - "================================================================"
          - ""
          - "Docker installation complete. Setting up Traefik reverse proxy..."
          - ""
      tags:
        - docker_setup
        - phase3

    # Phase 4: Traefik Setup
    - name: Run Traefik reverse proxy setup
      ansible.builtin.include_role:
        name: traefik
      tags:
        - traefik_setup
        - phase4

    - name: Display Traefik setup completion
      ansible.builtin.debug:
        msg:
          - "================================================================"
          - "üåê TRAEFIK REVERSE PROXY COMPLETED"
          - "================================================================"
          - ""
          - "Traefik setup complete. Installing monitoring system..."
          - ""
      tags:
        - traefik_setup
        - phase4

    # Phase 5: Monitoring Setup
    - name: Run monitoring system setup
      ansible.builtin.include_role:
        name: netdata
      tags:
        - monitoring_setup
        - phase5

  post_tasks:
    - name: Complete setup finished
      ansible.builtin.debug:
        msg:
          - "================================================================"
          - "üéâ COMPLETE SERVER SETUP FINISHED!"
          - "================================================================"
          - ""
          - "‚úÖ System hardening applied"
          - "‚úÖ CrowdSec security engine installed"
          - "‚úÖ Server rebooted with latest changes"
          - "‚úÖ Docker installed and configured"
          - "‚úÖ Traefik reverse proxy configured"
          - "‚úÖ Netdata monitoring installed"
          - "‚úÖ Production settings applied"
          - "‚úÖ All validations passed"
          - ""
          - "üîí SSH Access (via Tailscale):"
          - "   ssh {{ admin_username | default('admin') }}@{{ tailscale_ip | default('TAILSCALE_IP') }}"
          - ""
          - "üîß Management Commands:"
          - "   Docker Status: /usr/local/bin/docker-status"
          - "   Docker Cleanup: /usr/local/bin/docker-cleanup"
          - "   Stack Directory: {{ docker_stack_root }}"
          - "   Traefik Directory: {{ traefik_root_dir }}"
          - ""
          - "üìä Monitoring:"
          - "   Netdata: http://{{ tailscale_ip | default('TAILSCALE_IP') }}:{{ netdata_port }}"
          - ""
          - "üõ°Ô∏è Security:"
          - "   CrowdSec Status: sudo cscli collections list"
          - "   Security Alerts: sudo cscli alerts list"
          - "   Blocked IPs: sudo cscli decisions list"
          - "   Bouncer Status: sudo cscli bouncers list"
          - ""
          - "üöÄ Your server is ready for containerized applications!"
          - "   Deploy apps with Traefik labels for automatic SSL and routing"
          - ""
      tags: always 