#cloud-config
# =============================================================================
# Hetzner Cloud-Init Configuration
# =============================================================================
# This cloud-config sets up a secure Ubuntu server with:
# - Admin user with SSH key authentication
# - Kernel security hardening
# - Docker CE with security configurations
# - Tailscale VPN for secure access (SSH access via Tailscale only)
#
# IMPORTANT: Copy secrets.yml.example to secrets.yml and fill in your values
# Then use envsubst or manual replacement before deploying
# =============================================================================

# -----------------------------------------------------------------------------
# User Configuration
# -----------------------------------------------------------------------------
users:
    - name: <ADMIN_USERNAME>
      groups: users, admin, sudo, docker
      sudo: ALL=(ALL) NOPASSWD:ALL
      shell: /bin/bash
      ssh_authorized_keys:
          - <SSH_PUBLIC_KEY>

# -----------------------------------------------------------------------------
# Package Installation
# -----------------------------------------------------------------------------
packages:
    - curl
    - wget
    - gnupg
    - lsb-release
    - ca-certificates
    - apt-transport-https
    - software-properties-common
    - unattended-upgrades
    - net-tools
    - dnsutils
    - rsyslog
    - jq

package_update: true
package_upgrade: true

# -----------------------------------------------------------------------------
# File Configuration
# -----------------------------------------------------------------------------
write_files:
    # Kernel Security Hardening
    - path: /etc/sysctl.d/99-security-hardening.conf
      content: |
          # Kernel Security Hardening - Managed by cloud-init

          # Enable IP forwarding for Docker
          net.ipv4.ip_forward = 1

          # File descriptor limits for Docker
          fs.file-max = 1048576

          # Memory map count for Elasticsearch/Docker
          vm.max_map_count = 262144

          # Memory overcommit for Redis/Valkey background saves
          # Required to prevent data loss or crashes under low memory conditions
          vm.overcommit_memory = 1

          # Kernel pointer restriction
          kernel.kptr_restrict = 2

          # Restrict dmesg access
          kernel.dmesg_restrict = 1

          # Restrict perf events
          kernel.perf_event_paranoid = 3

          # Disable unprivileged BPF
          kernel.unprivileged_bpf_disabled = 1

          # Harden BPF JIT
          net.core.bpf_jit_harden = 2

          # Restrict ptrace scope
          kernel.yama.ptrace_scope = 2

          # Disable ICMP redirects
          net.ipv4.conf.all.accept_redirects = 0
          net.ipv4.conf.default.accept_redirects = 0
          net.ipv6.conf.all.accept_redirects = 0
          net.ipv6.conf.default.accept_redirects = 0

          # Disable source routing
          net.ipv4.conf.all.accept_source_route = 0
          net.ipv4.conf.default.accept_source_route = 0

          # Enable SYN flood protection
          net.ipv4.tcp_syncookies = 1

          # Log martian packets
          net.ipv4.conf.all.log_martians = 1
      permissions: "0644"

    # System Limits for Docker
    - path: /etc/security/limits.d/99-docker-limits.conf
      content: |
          # System Limits for Docker - Managed by cloud-init
          * soft nofile 1048576
          * hard nofile 1048576
          root soft nofile 1048576
          root hard nofile 1048576
          * soft nproc 65535
          * hard nproc 65535
      permissions: "0644"

    # Docker Daemon Configuration
    - path: /etc/docker/daemon.json
      content: |
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3",
              "compress": "true"
            },
            "live-restore": true,
            "userland-proxy": false,
            "no-new-privileges": true,
            "icc": true,
            "features": {
              "buildkit": true
            },
            "default-ulimits": {
              "nofile": {
                "Name": "nofile",
                "Hard": 64000,
                "Soft": 64000
              },
              "nproc": {
                "Name": "nproc",
                "Hard": 8192,
                "Soft": 4096
              }
            },
            "storage-driver": "overlay2",
            "exec-opts": ["native.cgroupdriver=systemd"],
            "metrics-addr": "127.0.0.1:9323",
            "experimental": false,
            "max-concurrent-downloads": 3,
            "max-concurrent-uploads": 5,
            "default-shm-size": "64M",
            "shutdown-timeout": 15
          }
      permissions: "0644"

    # Docker cleanup script
    - path: /usr/local/bin/docker-cleanup
      content: |
          #!/bin/bash
          # Docker Cleanup Script - Managed by cloud-init
          echo "Starting Docker cleanup..."
          docker container prune -f --filter "until=24h"
          docker image prune -f --filter "until=48h"
          docker volume prune -f
          docker builder prune -f --keep-storage=20GB
          docker network prune -f
          echo "Docker cleanup completed."
      permissions: "0755"

    # Docker status script
    - path: /usr/local/bin/docker-status
      content: |
          #!/bin/bash
          # Docker Status Script - Managed by cloud-init
          echo "=== Docker System Info ==="
          docker system info 2>/dev/null | grep -E "Containers|Images|Server Version|Storage Driver|Docker Root Dir"
          echo ""
          echo "=== Running Containers ==="
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "=== Disk Usage ==="
          docker system df
      permissions: "0755"

    # Unattended upgrades configuration
    - path: /etc/apt/apt.conf.d/50unattended-upgrades
      content: |
          Unattended-Upgrade::Allowed-Origins {
            "${distro_id}:${distro_codename}";
            "${distro_id}:${distro_codename}-security";
            "${distro_id}ESMApps:${distro_codename}-apps-security";
            "${distro_id}ESM:${distro_codename}-infra-security";
          };
          Unattended-Upgrade::AutoFixInterruptedDpkg "true";
          Unattended-Upgrade::Remove-Unused-Dependencies "true";
          Unattended-Upgrade::Automatic-Reboot "false";
      permissions: "0644"

# -----------------------------------------------------------------------------
# Commands to Run
# -----------------------------------------------------------------------------
runcmd:
    # Apply sysctl settings
    - sysctl --system

    # Install Docker
    - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list
    - apt-get update
    - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

    # Ensure docker group exists and add admin user
    - usermod -aG docker <ADMIN_USERNAME>

    # Enable and start Docker
    - systemctl enable docker
    - systemctl start docker

    # Create Docker directories
    - mkdir -p /opt/docker/{compose,data,config,logs}
    - chown -R <ADMIN_USERNAME>:<ADMIN_USERNAME> /opt/docker

    # Install Tailscale
    - curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/$(lsb_release -cs).noarmor.gpg | tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
    - echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/tailscale.list
    - apt-get update
    - apt-get install -y tailscale

    # Enable and start Tailscale
    - systemctl enable tailscaled
    - systemctl start tailscaled

    # Connect Tailscale with SSH enabled
    # --accept-dns=false: Prevents Tailscale MagicDNS from becoming the default DNS resolver
    # Without this, all DNS queries route through Tailscale (100.100.100.100) which may not
    # forward external queries properly, causing DNS timeouts for Docker Hub, apt, etc.
    - tailscale up --ssh --accept-dns=false --hostname=<TAILSCALE_HOSTNAME> --authkey=<TAILSCALE_AUTH_KEY>

    # Enable unattended upgrades
    - systemctl enable unattended-upgrades
    - systemctl start unattended-upgrades

    # Setup Docker cleanup cron job (daily at 2 AM)
    - echo "0 2 * * * root /usr/local/bin/docker-cleanup >> /var/log/docker-cleanup.log 2>&1" > /etc/cron.d/docker-cleanup

    # Disable ubuntu default user if it exists (security)
    - |
        if id "ubuntu" &>/dev/null; then
          usermod -L ubuntu
          usermod -s /usr/sbin/nologin ubuntu
        fi

    # Final reboot to apply all changes
    - reboot
