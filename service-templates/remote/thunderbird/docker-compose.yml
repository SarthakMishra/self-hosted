services:
  thunderbird:
    image: jlesage/thunderbird:latest
    container_name: thunderbird
    restart: unless-stopped
    
    # Environment configuration
    env_file:
      - .env
    
    environment:
      # User and group configuration
      - USER_ID=${USER_ID:-1000}
      - GROUP_ID=${GROUP_ID:-1000}
      
      # Timezone configuration
      - TZ=${TZ:-UTC}
      
      # Display configuration
      - DISPLAY_WIDTH=${THUNDERBIRD_DISPLAY_WIDTH:-1920}
      - DISPLAY_HEIGHT=${THUNDERBIRD_DISPLAY_HEIGHT:-1080}
      - DARK_MODE=${THUNDERBIRD_DARK_MODE:-0}
      
      # Web interface configuration
      - WEB_AUDIO=${THUNDERBIRD_WEB_AUDIO:-0}
      - WEB_FILE_MANAGER=${THUNDERBIRD_WEB_FILE_MANAGER:-0}
      - WEB_FILE_MANAGER_ALLOWED_PATHS=${THUNDERBIRD_WEB_FILE_MANAGER_ALLOWED_PATHS:-AUTO}
      
      # Security configuration
      - SECURE_CONNECTION=${THUNDERBIRD_SECURE_CONNECTION:-0}
      - VNC_PASSWORD=${THUNDERBIRD_VNC_PASSWORD:-}
      
      # Application configuration
      - KEEP_APP_RUNNING=${THUNDERBIRD_KEEP_APP_RUNNING:-1}
      - APP_NICENESS=${THUNDERBIRD_APP_NICENESS:-0}

    volumes:
      # Persistent storage for Thunderbird configuration and data
      - thunderbird_config:/config
      
      # Optional: Map downloads directory
      # - ./downloads:/config/downloads:rw
      
      # Optional: Map additional storage
      # - ./storage:/storage:rw

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.thunderbird-https.rule=Host(`${THUNDERBIRD_DOMAIN}`)"
      - "traefik.http.routers.thunderbird-https.entrypoints=websecure"
      - "traefik.http.routers.thunderbird-https.tls.certresolver=letsencrypt"
      - "traefik.http.routers.thunderbird-https.service=thunderbird"
      - "traefik.http.services.thunderbird.loadbalancer.server.port=5800"
      - "traefik.http.routers.thunderbird-https.middlewares=security-headers@file,crowdsec@file"

      - "com.centurylinklabs.watchtower.enable=true"

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5800 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

    # Network configuration
    networks:
      - app-network

    # Security options
    security_opt:
      - no-new-privileges:true

    # Optional: Expose VNC port if needed (uncomment if VNC access is required)
    # ports:
    #   - "5900:5900"

# Networks
networks:
  # External network for Traefik communication
  app-network:
    external: true

# Persistent volumes
volumes:
  thunderbird_config:
    driver: local
