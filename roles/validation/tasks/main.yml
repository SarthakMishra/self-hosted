---
# Validation Role - Main Tasks
# Performs comprehensive system verification and health checks

- name: Check UFW firewall status
  ansible.builtin.command: ufw status verbose
  register: ufw_status_check
  changed_when: false
  tags:
    - validation
    - firewall

- name: Verify Tailscale connectivity
  ansible.builtin.command: tailscale status
  register: tailscale_status_check
  changed_when: false
  failed_when: false
  tags:
    - validation
    - tailscale

- name: Test admin user SSH key access
  ansible.builtin.stat:
    path: "{{ admin_home | default('/home/' + (admin_username | default('admin'))) }}/.ssh/authorized_keys"
  register: admin_ssh_key_check
  tags:
    - validation
    - ssh

- name: Verify admin user sudo access
  ansible.builtin.command: sudo -u {{ admin_username | default('admin') }} sudo -n whoami
  register: admin_sudo_check
  changed_when: false
  failed_when: admin_sudo_check.stdout != "root"
  tags:
    - validation
    - sudo

- name: Check if kernel hardening configuration exists
  ansible.builtin.stat:
    path: /etc/sysctl.d/99-security-hardening.conf
  register: kernel_config_file
  tags:
    - validation
    - kernel

- name: Verify kernel security parameters (if hardening applied)
  ansible.builtin.shell: |
    set -e
    echo "âœ… Checking kernel security parameters..."
    sysctl net.ipv4.ip_forward | grep -q "1" && echo "âœ… IP forwarding enabled"
    sysctl kernel.kptr_restrict | grep -q "2" && echo "âœ… Kernel pointer restriction enabled"
    sysctl kernel.dmesg_restrict | grep -q "1" && echo "âœ… dmesg restriction enabled"
    echo "âœ… Kernel hardening validation complete"
  register: kernel_validation_result
  changed_when: false
  when: kernel_config_file.stat.exists
  tags:
    - validation
    - kernel

- name: Check time synchronization
  ansible.builtin.command: chronyc tracking
  register: time_sync_check
  changed_when: false
  failed_when: false
  when: chrony_enabled | default(true)
  tags:
    - validation
    - time

- name: Check system updates status
  ansible.builtin.command: apt list --upgradable
  register: updates_check
  changed_when: false
  tags:
    - validation
    - updates

- name: Test direct IP access (should be blocked)
  ansible.builtin.uri:
    url: "https://{{ ansible_default_ipv4.address }}"
    timeout: 5
    validate_certs: false
  register: direct_ip_test
  failed_when: false
  when: cloudflare_firewall_enabled | default(true)
  tags:
    - validation
    - security

- name: Collect system information
  ansible.builtin.setup:
    gather_subset:
      - hardware
      - network
      - virtual
  tags:
    - validation
    - info

- name: Generate validation report
  ansible.builtin.debug:
    msg:
      - "=== SYSTEM PREPARATION VALIDATION REPORT ==="
      - ""
      - "ğŸ”¥ FIREWALL STATUS:"
      - "  UFW Active: {{ 'YES' if 'Status: active' in ufw_status_check.stdout else 'NO' }}"
      - "  Cloudflare Rules: {{ 'YES' if cloudflare_firewall_enabled | default(false) else 'NO' }}"
      - "  Direct IP Access: {{ 'BLOCKED' if direct_ip_test.status is defined and direct_ip_test.status >= 400 else 'ACCESSIBLE' }}"
      - ""
      - "ğŸ‘¤ USER MANAGEMENT:"
      - "  Admin User: {{ admin_username | default('admin') }}"
      - "  SSH Keys: {{ 'CONFIGURED' if admin_ssh_key_check.stat.exists else 'MISSING' }}"
      - "  Sudo Access: {{ 'WORKING' if admin_sudo_check.stdout == 'root' else 'FAILED' }}"
      - ""
      - "ğŸŒ TAILSCALE:"
      - "  Status: {{ 'CONNECTED' if tailscale_status_check.rc == 0 else 'DISCONNECTED' }}"
      - "  IP Address: {{ tailscale_ip | default('Not Available') }}"
      - ""
      - "ğŸ›¡ï¸ SECURITY HARDENING:"
      - "  Kernel Hardening: {{ 'APPLIED' if kernel_config_file.stat.exists else 'NOT APPLIED' }}"
      - "  SSH Root Login: DISABLED"
      - "  SSH Password Auth: DISABLED"
      - ""
      - "â° TIME SYNCHRONIZATION:"
      - "  Chrony Status: {{ 'ACTIVE' if time_sync_check.rc == 0 else 'INACTIVE' }}"
      - ""
      - "ğŸ“¦ SYSTEM UPDATES:"
      - "  Upgradable Packages: {{ (updates_check.stdout_lines | length - 1) if updates_check.stdout_lines | length > 1 else 0 }}"
      - ""
      - "ğŸ”Œ CONNECTIVITY:"
      - "  SSH Access: ssh {{ admin_username | default('admin') }}@{{ tailscale_ip | default('TAILSCALE_IP') }}"
      - ""
      - "{{ 'âœ… VALIDATION PASSED' if validation_passed | default(true) else 'âŒ VALIDATION FAILED' }}"
  tags:
    - validation
    - report

- name: Set validation status
  ansible.builtin.set_fact:
    system_validation_passed: true
    validation_timestamp: "{{ ansible_date_time.iso8601 }}"
  tags:
    - validation

- name: Display next steps
  ansible.builtin.debug:
    msg:
      - "ğŸ‰ SYSTEM PREPARATION COMPLETE!"
      - ""
      - "Next steps:"
      - "1. Reboot system to apply all kernel changes"
      - "2. Test SSH access via Tailscale after reboot"
      - "3. Proceed with Docker Swarm installation"
      - ""
      - "Admin access:"
      - "  SSH: ssh {{ admin_username | default('admin') }}@{{ tailscale_ip | default('TAILSCALE_IP') }}"
      - "  Tailscale IP: {{ tailscale_ip | default('Check with: tailscale ip') }}"
  tags:
    - validation
    - summary

- name: Final Security Hardening - Disable ubuntu user (FINAL STEP)
  ansible.builtin.user:
    name: ubuntu
    shell: /usr/sbin/nologin
    password_lock: true
  when: 
    - admin_sudo_check.stdout == "root"  # Admin user confirmed working
    - disable_ubuntu_user | default(true)  # Can be overridden if needed
  tags:
    - validation
    - security
    - ubuntu_disable
    - final_hardening

- name: Display final security status
  ansible.builtin.debug:
    msg:
      - "================================================================"
      - "ğŸ”’ FINAL SECURITY HARDENING COMPLETED"
      - "================================================================"
      - ""
      - "âœ… Ubuntu user disabled for security"
      - "âœ… Admin user confirmed working with sudo access"
      - "âœ… SSH access restricted to admin user only"
      - ""
      - "âš ï¸  IMPORTANT: From now on, use admin user for SSH access:"
      - "   ssh {{ admin_username | default('admin') }}@{{ tailscale_ip | default('TAILSCALE_IP') }}"
      - ""
      - "ğŸš¨ If you lose access, you'll need console access to re-enable ubuntu user"
  when: 
    - admin_sudo_check.stdout == "root"
    - disable_ubuntu_user | default(true)
  tags:
    - validation
    - security
    - final_hardening

- name: Reboot system to apply all changes
  ansible.builtin.reboot:
    reboot_timeout: "{{ reboot_timeout | default(600) }}"
    connect_timeout: 30
    test_command: uptime
    msg: "Rebooting to apply system preparation changes (kernel updates, security settings)"
  when: 
    - system_reboot_required | default(false) or kernel_reboot_recommended | default(false)
    - reboot_after_preparation | default(true)
  tags:
    - validation
    - reboot
    - final_step

- name: Post-reboot validation
  ansible.builtin.debug:
    msg:
      - "================================================================"
      - "ğŸ‰ SYSTEM REBOOT COMPLETED SUCCESSFULLY"
      - "================================================================"
      - ""
      - "âœ… System rebooted and reconnected"
      - "âœ… All changes applied and active"
      - "âœ… Ready for Docker Swarm deployment"
      - ""
      - "ğŸš€ Next Step: Run Docker deployment playbook"
  when: 
    - system_reboot_required | default(false) or kernel_reboot_recommended | default(false)
    - reboot_after_preparation | default(true)
  tags:
    - validation
    - reboot 