---
# Single Node Docker Setup Playbook
# Optimized for single server Docker Swarm deployments

- name: Single Node Docker Installation and Configuration
  hosts: single_node
  become: true
  gather_facts: true
  
  vars_files:
    # Include Docker configuration variables
    - ../group_vars/docker.yml
    
  vars:
    # Single node specific settings
    docker_swarm_enabled: true
    node_type: single
    traefik_enabled: true
    whalewall_enabled: true
    
  pre_tasks:
    - name: Display single node Docker setup banner
      ansible.builtin.debug:
        msg:
          - "=================================================="
          - "üéØ SINGLE NODE DOCKER SETUP"
          - "=================================================="
          - ""
          - "Target: {{ inventory_hostname }} ({{ ansible_default_ipv4.address }})"
          - "Deployment: Single Node Docker Swarm (All-in-One)"
          - "Traefik: {{ traefik_enabled }}"
          - "Whalewall: {{ whalewall_enabled }}"
          - ""
          - "‚ö†Ô∏è  This creates a complete Docker environment on one server"
          - "üêù Single-node Swarm cluster for full orchestration features"
          - "üåê Encrypted networks for security"
          - "üî• UFW/Docker integration for firewall management"
          - ""
      tags: always

    - name: Verify single node configuration
      ansible.builtin.assert:
        that:
          - node_type == "single"
          - traefik_enabled == true
          - docker_swarm_enabled == true
        fail_msg: "Single node deployment requires specific configuration"
        success_msg: "Single node configuration verified"
      tags: always

  roles:
    - role: docker_installation
      tags: 
        - docker_installation
        - phase1
      
    - role: docker_configuration
      tags:
        - docker_configuration
        - phase1
        
    - role: docker_swarm
      tags:
        - docker_swarm
        - phase2
        
    - role: docker_networks
      tags:
        - docker_networks
        - phase2
        
    - role: docker_production
      tags:
        - docker_production
        - phase3
        
    - role: whalewall
      tags:
        - whalewall
        - phase3
        
    - role: docker_validation
      tags:
        - docker_validation
        - phase4
        
    - role: docker_services
      tags:
        - docker_services
        - services
        - phase5
      when: deploy_docker_services | default(true)
        
    - role: restic_backup
      tags:
        - restic_backup
        - backup
        - phase6
      when: deploy_restic_backup | default(true)

  post_tasks:
    - name: Single node Docker setup complete
      ansible.builtin.debug:
        msg:
          - "================================================================"
          - "üéâ SINGLE NODE DOCKER SETUP COMPLETED!"
          - "================================================================"
          - ""
          - "‚úÖ Complete Docker environment on single server"
          - "‚úÖ Docker Swarm cluster initialized"
          - "‚úÖ Production-ready networking and security"
          - "‚úÖ Ready for service deployment"
          - ""
          - "üê≥ Single Node Advantages:"
          - "  ‚Ä¢ Complete Docker Swarm functionality"
          - "  ‚Ä¢ Simplified management and monitoring"
          - "  ‚Ä¢ Cost-effective for small to medium workloads"
          - "  ‚Ä¢ Easy to scale horizontally when needed"
          - ""
          - "üåê Network Configuration:"
          - "  ‚Ä¢ App Network: 10.1.0.0/20 (encrypted)"
          - "  ‚Ä¢ Monitoring Network: 10.2.0.0/20 (encrypted)"
          - "  ‚Ä¢ Database Network: 10.3.0.0/20 (internal)"
          - "  ‚Ä¢ Local Bridge: 172.20.0.0/16"
          - ""
          - "üìã Next Steps:"
          - "1. Deploy Traefik reverse proxy"
          - "2. Deploy monitoring stack (Netdata)"
          - "3. Deploy application services"
          - "4. Configure backup automation"
          - ""
          - "üîß Management:"
          - "  Stack Directory: {{ docker_stack_root }}"
          - "  Status Command: /usr/local/bin/docker-status"
          - "  Cleanup Command: /usr/local/bin/docker-cleanup"
          - ""
      tags: always 