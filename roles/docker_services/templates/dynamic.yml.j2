# Dynamic configuration for Traefik with Cloudflare optimizations
# This file is mounted as a volume and provides TLS configuration

tls:
  options:
    # Cloudflare authenticated origin pulls
    cloudflare:
      minVersion: "VersionTLS12"
      maxVersion: "VersionTLS13"
      cipherSuites:
        - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
        - "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305"
        - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
        - "TLS_RSA_WITH_AES_256_GCM_SHA384"
        - "TLS_RSA_WITH_AES_128_GCM_SHA256"
      curvePreferences:
        - "X25519"
        - "secp384r1"
      sniStrict: true
      # Cloudflare origin CA certificate for client authentication
      clientAuth:
        caFiles:
          - "/etc/traefik/cloudflare-origin-ca.pem"
        clientAuthType: "RequireAndVerifyClientCert"

    # Default TLS options (more relaxed for other services)
    default:
      minVersion: "VersionTLS12"
      maxVersion: "VersionTLS13"
      cipherSuites:
        - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
        - "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305"
        - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
        - "TLS_RSA_WITH_AES_256_GCM_SHA384"
        - "TLS_RSA_WITH_AES_128_GCM_SHA256"
      curvePreferences:
        - "X25519"
        - "secp384r1"
      sniStrict: false

http:
  middlewares:
    # Cloudflare IP whitelist - restricts access to Cloudflare IPs only
    cloudflare-ips:
      ipWhiteList:
        sourceRange:
          # Cloudflare IPv4 ranges (update periodically from https://www.cloudflare.com/ips/)
          - "173.245.48.0/20"
          - "103.21.244.0/22"
          - "103.22.200.0/22"
          - "103.31.4.0/22"
          - "141.101.64.0/18"
          - "108.162.192.0/18"
          - "190.93.240.0/20"
          - "188.114.96.0/20"
          - "197.234.240.0/22"
          - "198.41.128.0/17"
          - "162.158.0.0/15"
          - "104.16.0.0/13"
          - "104.24.0.0/14"
          - "172.64.0.0/13"
          - "131.0.72.0/22"
          # Cloudflare IPv6 ranges
          - "2400:cb00::/32"
          - "2606:4700::/32"
          - "2803:f800::/32"
          - "2405:b500::/32"
          - "2405:8100::/32"
          - "2a06:98c0::/29"
          - "2c0f:f248::/32"

    # Enhanced security headers optimized for Cloudflare
    cloudflare-headers:
      headers:
        addVaryHeader: true
        referrerPolicy: "strict-origin-when-cross-origin"
        hostsProxyHeaders:
          - "X-Forwarded-Host"
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          CF-Visitor: '{"scheme":"https"}'
        frameDeny: true
        contentTypeNosniff: true
        browserXssFilter: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 63072000
        forceSTSHeader: true
        permissionsPolicy: "geolocation=(),midi=(),sync-xhr=(),microphone=(),camera=(),magnetometer=(),gyroscope=(),fullscreen=(self),payment=()"
        contentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-ancestors 'none';"

    # Rate limiting optimized for Cloudflare traffic
    cloudflare-rate-limit:
      rateLimit:
        average: 300
        burst: 150
        period: "1m"
        sourceCriterion:
          requestHeaderName: "CF-Connecting-IP"
          requestHost: true

    # Compress responses for better performance
    gzip-compression:
      compress: {}

# Certificate configuration for wildcard support
certificates:
  - certFile: "/certs/wildcard.crt"
    keyFile: "/certs/wildcard.key" 