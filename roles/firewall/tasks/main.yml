---
# Firewall Role - Main Tasks
# Handles UFW configuration with open HTTP/HTTPS access

- name: Reset UFW to clean state
  community.general.ufw:
    state: reset
  when: firewall_reset | default(true)
  tags:
    - firewall
    - ufw

- name: Set UFW default policies
  community.general.ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: 'incoming', policy: 'deny' }
    - { direction: 'outgoing', policy: 'allow' }
  tags:
    - firewall
    - ufw

- name: Allow HTTP access from anywhere
  community.general.ufw:
    rule: allow
    to_port: "80"
    proto: tcp
    comment: "HTTP access"
  tags:
    - firewall
    - web

- name: Allow HTTPS access from anywhere
  community.general.ufw:
    rule: allow
    to_port: "443"
    proto: tcp
    comment: "HTTPS access"
  tags:
    - firewall
    - web

- name: Enable UFW
  community.general.ufw:
    state: enabled
  when: firewall_enabled | default(true)
  tags:
    - firewall
    - ufw

- name: Display firewall status
  ansible.builtin.command: ufw status verbose
  register: ufw_status
  changed_when: false
  tags:
    - firewall
    - status

- name: Show UFW configuration
  ansible.builtin.debug:
    var: ufw_status.stdout_lines
  tags:
    - firewall
    - status

- name: Display configuration summary
  ansible.builtin.debug:
    msg:
      - "Firewall configuration completed"
      - "HTTP (80): Open to all"
      - "HTTPS (443): Open to all"
      - ""
      - "üîí SECURITY: SSH port 22 blocked from public internet"
      - "üåê ACCESS: Use Tailscale SSH for secure admin access"
  tags:
    - firewall
    - status 